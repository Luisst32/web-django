{% load static %}
<!-- Swap OOB: Hide Right Sidebar when showing Profile -->
<div id="right-sidebar-container" hx-swap-oob="true" class="d-none"></div>

<!-- CONTENEDOR CENTRAL del Perfil -->
<!-- Removing "container" and fixed "900px" width to fit in col-lg-6 context fluidly -->
<div class="px-0 mb-4 w-100">

    <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-4 bg-white">
        <!-- Portada -->
        <div style="height: 200px; position: relative;">
            {% if perfil.foto_portada %}
            <img src="{{ perfil.foto_portada.url }}" class="w-100 h-100 object-fit-cover"
                alt="Portada de {{ usuario.username }}">
            {% else %}
            <div class="w-100 h-100 bg-secondary"></div>
            {% endif %}

            <!-- Botón de regreso (Overlay) -->
            <a href="{% url 'index' %}"
                class="position-absolute top-0 start-0 m-3 btn btn-light rounded-circle shadow-sm p-2 opacity-75 hover-opacity-100 text-dark"
                style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>

        <!-- Cuerpo del Perfil -->
        <div class="card-body text-center position-relative pt-0 px-3 pb-4">
            <!-- Avatar superpuesto -->
            <div class="mx-auto position-relative"
                style="width: 120px; height: 120px; margin-top: -60px; margin-bottom: 0.5rem;">
                {% if usuario.foto_perfil %}
                <img src="{{ usuario.foto_perfil.url }}"
                    class="w-100 h-100 rounded-circle border border-4 border-white shadow bg-white object-fit-cover"
                    alt="Avatar">
                {% else %}
                <div
                    class="w-100 h-100 rounded-circle border border-4 border-white shadow bg-light d-flex align-items-center justify-content-center text-muted display-4">
                    <i class="fas fa-user"></i>
                </div>
                {% endif %}

                <!-- Indicador Online/Offline -->
                <span id="user-connection-status"
                    class="position-absolute bottom-0 end-0 p-2 border border-2 border-white rounded-circle bg-secondary"
                    style="width: 18px; height: 18px; right: 10px !important; bottom: 8px !important; display: none;"
                    title="Estado de conexión">
                </span>
            </div>

            <h2 class="fw-bold mb-0 text-dark fs-5 d-flex align-items-center justify-content-center gap-2">
                {{ usuario.first_name }} {{ usuario.last_name }}
                {% if usuario.verification_badge and usuario.verification_badge.icon %}
                <img src="{{ usuario.verification_badge.icon.url }}" alt="{{ usuario.verification_badge.name }}"
                    title="{{ usuario.verification_badge.description }}" style="width: 20px; height: 20px;"
                    data-bs-toggle="tooltip" data-bs-placement="top">
                {% endif %}
            </h2>
            <p class="text-muted mb-2 small">@{{ usuario.username }}</p>

            <!-- Bio -->
            {% if perfil.bio %}
            <div class="mb-3 text-secondary mx-auto small" style="max-width: 90%; line-height: 1.5;">
                {{ perfil.bio|linebreaksbr }}
            </div>
            {% endif %}

            <!-- SEGUIDORES y ACCIONES -->
            <div class="d-flex align-items-center justify-content-center gap-3 mb-3">
                <!-- Contador simplificado -->
                <div class="text-dark">
                    <span class="fw-bold fs-6" id="follower-count">{{ cantidad_seguidores }}</span>
                    <span class="text-muted small">Seguidores</span>
                </div>

                <!-- Botón Seguir (Icono) - Solo si no es el dueño -->
                {% if usuario != request.user %}
                {% if esta_siguiendo %}
                <a href="#" onclick="toggleFollow(event, '{{ usuario.id }}')"
                    class="btn btn-light rounded-circle border shadow-sm d-flex align-items-center justify-content-center text-danger"
                    style="width: 36px; height: 36px;" title="Dejar de seguir">
                    <i class="fas fa-user-check"></i>
                </a>
                {% else %}
                <a href="#" onclick="toggleFollow(event, '{{ usuario.id }}')"
                    class="btn btn-dark rounded-circle shadow-sm d-flex align-items-center justify-content-center"
                    style="width: 36px; height: 36px;" title="Seguir">
                    <i class="fas fa-user-plus"></i>
                </a>
                {% endif %}
                {% endif %}
            </div>

            <!-- Botón Editar Perfil (Visible solo para dueño) -->
            {% if usuario == request.user %}
            <div class="mb-3">
                <a href="{% url 'editar_perfil' username=usuario.username %}"
                    class="btn btn-black rounded-pill px-3 py-1 fw-bold fs-6">
                    <i class="fas fa-pencil-alt me-2"></i>Editar
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- COMPOSER (Si es dueño) -->
    {% if es_perfil_del_usuario_logueado %}
    <div class="card border-0 shadow-sm rounded-4 mb-3 mx-auto w-100">
        <div class="card-body p-3 d-flex align-items-center gap-2">
            {% if usuario.foto_perfil %}
            <img src="{{ usuario.foto_perfil.url }}" class="rounded-circle object-fit-cover"
                style="width: 36px; height: 36px;" alt="Avatar">
            {% else %}
            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
                style="width: 36px; height: 36px;">
                <i class="fas fa-user text-muted"></i>
            </div>
            {% endif %}
            <a href="{% url 'publications:crear_publicacion' %}" class="flex-grow-1 text-decoration-none"
                style="display: block;">
                <div class="form-control rounded-pill bg-light border-0 px-3 py-2 text-muted small"
                    style="cursor: pointer;">
                    ¿Qué estás pensando, {{ usuario.first_name }}?
                </div>
            </a>
            <a href="{% url 'publications:crear_publicacion' %}" class="text-success">
                <i class="fas fa-image fa-lg"></i>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- PUBLICACIONES -->
    <div class="publicaciones-container">
        {% include 'publications/lista_publicaciones.html' %}
    </div>

    <!-- HTMX Indicator (Spinner) -->
    <div class="htmx-indicator text-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>
</div>

<script>
    // Re-instantiate script logic for swapped content
    // We wrap in a block to avoid redeclaration errors if swapped multiple times
    {
        // 0. layout adjustment: Expand main column to take available space
        const mainCol = document.getElementById('main-content-col');
        if (mainCol) {
            mainCol.classList.remove('col-lg-6');
            mainCol.classList.add('col-lg-9');
        }

        // 0.1 Remove max-width constraint from the feed container itself
        const feedContainer = document.getElementById('publicaciones-feed-container');
        if (feedContainer) {
            feedContainer.style.maxWidth = '100%';
        }

        const wsProto = window.location.protocol === 'https:' ? 'wss://' : 'ws://';

        // --- 1. WebSocket de ESTADO (Online/Offline) ---
        try {
            // Use the generic presence channel
            const userSocket = new WebSocket(
                wsProto + window.location.host + '/ws/presence/'
            );
            userSocket.onopen = () => {
                // Optional: ask for status? 
                // userSocket.send(JSON.stringify({ action: 'check_status', user_id: '{{ usuario.id }}' }));
            };
            userSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);

                // Filter updates specifically for this profile's user
                if (parseInt(data.user_id) === parseInt('{{ usuario.id }}')) {
                    const statusBadge = document.getElementById('user-connection-status');
                    if (statusBadge) {
                        if (data.status === 'online') {
                            statusBadge.style.display = 'inline-block';
                            statusBadge.classList.replace('bg-secondary', 'bg-success');
                        } else {
                            statusBadge.style.display = 'inline-block';
                            statusBadge.classList.replace('bg-success', 'bg-secondary');
                        }
                    }
                }
            };
        } catch (err) {
            console.error("Error connecting User WebSocket:", err);
        }

        // --- 2. WebSocket de PERFIL (Seguidores en tiempo real) ---
        try {
            const profileSocket = new WebSocket(
                wsProto + window.location.host + '/ws/profile/{{ usuario.id }}/'
            );
            profileSocket.onopen = function (e) { console.log("Profile WS connected"); };
            profileSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                if (data.type === 'follower_update') {
                    const countEl = document.getElementById('follower-count');
                    if (countEl) {
                        countEl.textContent = data.new_count;
                    }
                }
            };
        } catch (e) { console.warn("WS Profile Error", e); }
    }
</script>