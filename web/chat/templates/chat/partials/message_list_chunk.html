{% if has_next %}
<div id="pagination-sentinel" hx-get="{% url 'get_chat_history' otro_usuario.id %}?page={{ next_page }}"
    hx-trigger="intersect once" hx-target="#pagination-sentinel" hx-swap="outerHTML" class="text-center p-2">
    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
</div>
{% endif %}

{% for mensaje in mensajes %}
<div class="message mb-2 d-flex {% if mensaje.user == request.user %}justify-content-end{% endif %}">
    <div class="message-bubble p-2 rounded-3 shadow-sm"
        style="max-width: 80%; {% if mensaje.tipo == 'imagen' %}background: transparent; box-shadow: none !important;{% elif mensaje.user == request.user %}background: #0084ff; color: white;{% else %}background: white; color: #1c1e21;{% endif %}">
        {% if mensaje.tipo == 'imagen' %}
        <img src="{{ mensaje.imagen.url }}" class="img-fluid rounded-2 mb-1"
            style="max-height: 250px; cursor: pointer; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);"
            onclick="window.open('{{ mensaje.imagen.url }}', '_blank')">
        {% else %}
        <div class="message-text" style="word-wrap: break-word;">{{ mensaje.descripcion }}</div>
        {% endif %}

        <div class="d-flex justify-content-between align-items-center mt-1" style="font-size: 0.7rem; opacity: 0.9;">
            {% if mensaje.user.id == request.user.id %}
            <div class="message-status status-sent me-2"
                style="{% if mensaje.es_leido %}color: {% if mensaje.imagen %}#0084ff{% else %}#d1f2ff{% endif %}; font-weight: bold;{% else %}color: {% if mensaje.imagen %}#666{% else %}#e0e0e0{% endif %};{% endif %}">
                {% if mensaje.es_leido %}
                <i class="fas fa-check-double"></i> Visto
                {% else %}
                <i class="fas fa-check"></i> Enviado
                {% endif %}
            </div>
            {% endif %}
            <div>{{ mensaje.fecha_mensaje|date:"H:i" }}</div>
        </div>
    </div>
</div>
{% endfor %}